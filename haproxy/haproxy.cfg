############################
#  HAProxy – dynamic agent #
############################

global
    log stdout format raw local0 debug   # debug → mostra health-checks
    daemon
    maxconn 2048

defaults
    log     global
    mode    http
    option  httplog
    option  dontlognull
    option  log-health-checks            # registra cada agent-check
    timeout connect 5s
    timeout client  30s
    timeout server  30s
    retries 3

# ── Docker DNS resolver ─────────────────────────────────────
resolvers docker
    nameserver dns1 127.0.0.11:53
    resolve_retries 3
    timeout resolve 1s
    timeout retry   1s
    hold other      10s
    hold refused    10s
    hold nx         10s
    hold timeout    10s
    hold valid      10s

# ── Frontend ────────────────────────────────────────────────
frontend http-in
    bind *:80
    default_backend apis               # todo o tráfego vai pro backend

# ── Backend com agent-check dinâmico ─────────────────────────
backend apis
    balance roundrobin                 # ou leastconn, se preferir
    server-template api 1-10 tasks.api:5000 weight 100 agent-check agent-port 9999 agent-inter 2s check inter 2s rise 2 fall 3  resolve-prefer ipv4 resolvers docker init-addr none

# ── Painel /stats ───────────────────────────────────────────
listen stats
    bind *:8404
    mode http
    stats enable
    stats uri /stats
    stats refresh 5s
    stats show-node
